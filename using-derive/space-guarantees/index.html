<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Space Guarantees - The Dipa Book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../using-derive/index.html"><strong aria-hidden="true">1.</strong> Using Derive</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../using-derive/attributes/index.html"><strong aria-hidden="true">1.1.</strong> Attributes</a></li><li class="chapter-item expanded "><a href="../../using-derive/space-guarantees/index.html" class="active"><strong aria-hidden="true">1.2.</strong> Space Guarantees</a></li><li class="chapter-item expanded "><a href="../../using-derive/delta-encoding-optimizations/index.html"><strong aria-hidden="true">1.3.</strong> Delta Encoding Optimizations</a></li></ol></li><li class="chapter-item expanded "><a href="../../diff-performance/index.html"><strong aria-hidden="true">2.</strong> Performance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../diff-performance/lists/index.html"><strong aria-hidden="true">2.1.</strong> Lists</a></li><li class="chapter-item expanded "><a href="../../diff-performance/changed-flags/index.html"><strong aria-hidden="true">2.2.</strong> Changed Flags</a></li></ol></li><li class="chapter-item expanded "><a href="../../custom-diffing/index.html"><strong aria-hidden="true">3.</strong> Custom Delta Encoding</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../custom-diffing/implementing-diffable/index.html"><strong aria-hidden="true">3.1.</strong> Implement Diffable</a></li><li class="chapter-item expanded "><a href="../../custom-diffing/implementing-patchable/index.html"><strong aria-hidden="true">3.2.</strong> Implement Patchable</a></li><li class="chapter-item expanded "><a href="../../custom-diffing/testing-your-implementation/index.html"><strong aria-hidden="true">3.3.</strong> Testing Your Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/index.html"><strong aria-hidden="true">4.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../../feature-flags/index.html"><strong aria-hidden="true">5.</strong> Feature Flags</a></li><li class="chapter-item expanded "><a href="../../roadmap/index.html"><strong aria-hidden="true">6.</strong> Roadmap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../roadmap/optimizations/index.html"><strong aria-hidden="true">6.1.</strong> Optimizations</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../internal-design/index.html"><strong aria-hidden="true">7.</strong> Internal Design</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Dipa Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#space-guarantees" id="space-guarantees">Space Guarantees</a></h1>
<p>FIXME: Move this documentation to a subchapter within the optimizations chapter where we talk about the one_batch strategy.</p>
<h2><a class="header" href="#single-byte-no-change-rule" id="single-byte-no-change-rule">Single Byte No Change Rule</a></h2>
<p>Given a struct or enum type that uses <code>#[dipa(delta_strategy = &quot;one_batch&quot;)]</code>, or any type in the standard library
that we've implemented the <code>Diffable</code> trait for.</p>
<p>Its unchanged delta encoding is guaranteed to be serialize-able to a single byte.</p>
<hr />
<p>Note that this rule is true for nested data structures. If all nested types properly implement
<code>Diffable</code> and your root type uses the derive macro, it can be delta encoded down to 1 byte when
it has not changed.</p>
<p>Note that this rule applies to enum <strong>fields</strong> not variants. i.e. in <code>MyEnum::A(1, 2, 3)</code>, the
fields are &quot;1, 2, 3&quot;. This rule applies to enums with any number f variants.</p>
<p>Your nested types do <strong>not</strong> need to use the <code>one_batch</code> strategy. The strategy that they use does
not matter for this rule.</p>
<hr />
<p>In the following code snippet, all three types can be delta compressed down to a single byte
when they haven't changed.</p>
<pre><pre class="playpen"><code class="language-rust">// If this type has not changed its delta can be serialized to
// a single byte.
#[derive(DiffPatch)]
MyStruct {
    field_a: Vec&lt;f32&gt;,
    field_b: HashMap&lt;u8, HashSet&lt;MyEnum&gt;&gt;,
    field_c: AnotherStruct
}

// If this type has not changed its delta can be serialized to
// a single byte.
// Remember: this rule applies to fields, not variants.
#[derive(DiffPatch, Hash, Eq, Ord)]
enum MyEnum {
    A,
    B([Vec&lt;u8&gt;; 2], i32),
    C { some_field: i128 },
    D, E, F, G, H, I, J, K, L, M,
    N, O, P, Q, R, S, T, U, V, W,
    X, Y, Z
}

// If this type has not changed its delta can be serialized to
// a single byte.
#[derive(DiffPatch)]
struct AnotherStruct(i8, u8, MyEnum);

fn main () {
    let my_struct = make_my_struct();
    let other = make_my_struct();

    let diff = my_struct.create_diff_towards(&amp;other);

    let serialized: Vec&lt;u8&gt; = bincode::options()
        .with_varint_encoding()
        .serialize(&amp;diff)
        .unwrap();

    // True for all types that properly implement the
    // Diffable trait.
    assert_eq!(serialized.len(), 1);
}

fn make_my_struct () -&gt; MyStruct {
    let mut hash_set = HashSet::new();
    hash_set.inset(MyEnum::A);

    let mut field_b = HashMap::new();
    field_b.insert(200, hash_set);

	MyStruct {
        field_a: vec![1., 2., 3., 4., 5.],
        field_b,
        field_c: AnotherStruct(
            -1,
            2,
            MyEnum::B([vec![6, 7], vec![8]], -3)
        )
    }
}
</code></pre></pre>
<h3><a class="header" href="#why-5-fields" id="why-5-fields">Why 5 fields?</a></h3>
<p>The derive macro generates a <code>Diffable::Delta</code> associated type that is an enum containing every possible combination of changed fields.</p>
<p>This means that there are <code>2&lt;super&gt;n&lt;/super&gt;</code> enum variants that get generated, where <code>n</code> is the number of fields in your struct or within an
enum variant. Since this is exponential, it grows quickly.</p>
<p>For now we choose <code>5</code> as as starting point for the maximum number of fields that we combine into a single <code>Delta</code> enum in this way, but in the future we
will experiment with larger numbers in order to find the sweet spot where the number is as high as it can be before the potential impact on compile
times becomes non-negligible.</p>
<p>We will take real applications that use <code>#[derive(DiffPatch)]</code> on non trivial data structures and benchmark the fresh and incremental compile times as <code>n</code>
increases.</p>
<p>Or, perhaps we'll expose feature flags that allow you to increase <code>n</code> yourself. Or better yet a procedural macro attribute that can configure the <code>n</code> value.</p>
<p>Note that your structs can still have more than 5 fields. They'll just diff to <code>(field_count / 5.0).ceil()</code> bytes when unchanged.</p>
<p>So, currently, if you have 9 fields in a struct it will diff to 2 bytes when unchanged.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../using-derive/attributes/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../using-derive/delta-encoding-optimizations/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../using-derive/attributes/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../using-derive/delta-encoding-optimizations/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
